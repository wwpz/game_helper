让我先查看你提到的 daily_task.py 文件，然后为你展示如何将其改造为基于 PluginBase 的插件。




**已查看文件** *daily_task.py*


现在我来为你展示如何将 [daily_task.py](file:///F:/me/StarRailHelper/core/modules/game/daily_task/daily_task.py) 中的功能改造为基于 [PluginBase](file:///F:/me/StarRailHelper/service/service_factory.py#L17-L17) 的插件。

## 改造方案

我会将 [DailyTask](file:///F:/me/StarRailHelper/core/modules/game/daily_task/daily_task.py#L12-L139) 类中的每个静态方法改造成独立的插件。以下是改造后的代码：

### 1. 委托任务插件

```python
# plugins/daily/entrust_plugin.py
from core.plugins.base.plugin_base import PluginBase

class EntrustPlugin(PluginBase):
    """委托任务插件"""
    
    @property
    def name(self) -> str:
        return "daily_entrust"
    
    @property
    def description(self) -> str:
        return "执行日常委托任务"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 10
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行委托任务"""
        try:
            self.log.info(f"账号 {self.account} 开始执行委托任务")
            
            # 获取模拟器实例
            simulator = self.adapter.get_simulator()
            if not simulator:
                raise Exception("无法获取模拟器实例")
            
            # 原有逻辑实现
            image = simulator.take_screenshot_pil()
            screenshot = simulator.edit_photo(image)
            ocr_res = simulator.ocr.runBytes(screenshot)
            
            if simulator.compare_ocr_text(ocr_res, "委托"):
                center = simulator.get_box_center_by_text(ocr_res, "委托")
                simulator.click(center[0], center[1])
                self._wait(2)
                
                if simulator.click_element("./res/images/daily_task/entrust_receive_award.png"):
                    self._wait(2)
                    if simulator.click_element("./res/images/daily_task/entrust_again.png", is_save=True,
                                              screenshot_module="entrust"):
                        self._wait(2)
                        
            if simulator.click_element("./res/images/daily_task/entrust_close.png"):
                self._wait(2)
            
            self.log.info(f"账号 {self.account} 委托任务执行完成")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account
            }
            
        except Exception as e:
            self.log.error(f"执行委托任务时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
    
    def _wait(self, seconds: int) -> None:
        """等待指定秒数"""
        from utils.time_util import TimeUtil
        TimeUtil.sleep(seconds)
```


### 2. 邮件任务插件

```python
# plugins/daily/mail_plugin.py
from core.plugins.base.plugin_base import PluginBase

class MailPlugin(PluginBase):
    """邮件任务插件"""
    
    @property
    def name(self) -> str:
        return "daily_mail"
    
    @property
    def description(self) -> str:
        return "领取邮件奖励"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 20
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行邮件任务"""
        try:
            self.log.info(f"账号 {self.account} 开始领取邮件奖励")
            
            # 获取模拟器实例
            simulator = self.adapter.get_simulator()
            if not simulator:
                raise Exception("无法获取模拟器实例")
            
            # 原有逻辑实现
            image = simulator.take_screenshot_pil()
            screenshot = simulator.edit_photo(image)
            ocr_res = simulator.ocr.runBytes(screenshot)
            center = simulator.get_box_center_by_text(ocr_res, "开拓等级", exact=False)
            
            if center:
                simulator.click(center[0] + 650, center[1])
                self._wait(2)
                
                if simulator.click_element("./res/images/daily_task/mail_receive_award.png", is_save=True,
                                          screenshot_module="mail"):
                    self._wait(2)
                    if simulator.click_element("./res/images/daily_task/mail_receive_close.png"):
                        self._wait(2)
                        
                if simulator.click_element("./res/images/daily_task/mail_close.png"):
                    self._wait(2)
            
            self.log.info(f"账号 {self.account} 邮件奖励领取完成")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account
            }
            
        except Exception as e:
            self.log.error(f"领取邮件奖励时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
    
    def _wait(self, seconds: int) -> None:
        """等待指定秒数"""
        from utils.time_util import TimeUtil
        TimeUtil.sleep(seconds)
```


### 3. 活跃度任务插件

```python
# plugins/daily/liveness_plugin.py
from core.plugins.base.plugin_base import PluginBase

class LivenessPlugin(PluginBase):
    """活跃度任务插件"""
    
    @property
    def name(self) -> str:
        return "daily_liveness"
    
    @property
    def description(self) -> str:
        return "领取活跃度奖励"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 30
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行活跃度任务"""
        try:
            self.log.info(f"账号 {self.account} 开始领取活跃度奖励")
            
            # 获取模拟器实例
            simulator = self.adapter.get_simulator()
            if not simulator:
                raise Exception("无法获取模拟器实例")
            
            # 原有逻辑实现
            if simulator.click_element("./res/images/daily_task/phone.png"):
                self._wait(3)
                image = simulator.take_screenshot_pil()
                screenshot = simulator.edit_photo(image)
                ocr_res = simulator.ocr.runBytes(screenshot)
                
                if simulator.compare_ocr_text(ocr_res, "指南"):
                    center = simulator.get_box_center_by_text(ocr_res, "指南")
                    if center:
                        simulator.click(center[0], center[1])
                        self._wait(2)
                        
                        while True:
                            if simulator.click_element("./res/images/daily_task/liveness_receive_award.png"):
                                self._wait(1)
                            else:
                                break
                                
                        if simulator.find_element("./res/images/daily_task/liveness_500.png", is_save=True,
                                                 screenshot_module="liveness"):
                            if simulator.click_element("./res/images/daily_task/liveness_receive_award2.png"):
                                self._wait(2)
                                if simulator.click_element("./res/images/daily_task/liveness_close.png", is_save=True,
                                                          screenshot_module="liveness2"):
                                    self._wait(2)
                                    if simulator.click_element("./res/images/daily_task/entrust_close.png"):
                                        self._wait(2)
            
            self.log.info(f"账号 {self.account} 活跃度奖励领取完成")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account
            }
            
        except Exception as e:
            self.log.error(f"领取活跃度奖励时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
    
    def _wait(self, seconds: int) -> None:
        """等待指定秒数"""
        from utils.time_util import TimeUtil
        TimeUtil.sleep(seconds)
```


### 4. 活动任务插件

```python
# plugins/daily/activity_plugin.py
from core.plugins.base.plugin_base import PluginBase

class ActivityPlugin(PluginBase):
    """活动任务插件"""
    
    @property
    def name(self) -> str:
        return "daily_activity"
    
    @property
    def description(self) -> str:
        return "领取活动奖励"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 40
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行活动任务"""
        try:
            self.log.info(f"账号 {self.account} 开始领取活动奖励")
            
            # 获取模拟器实例
            simulator = self.adapter.get_simulator()
            if not simulator:
                raise Exception("无法获取模拟器实例")
            
            # 原有逻辑实现
            if simulator.click_element("./res/images/daily_task/phone.png"):
                self._wait(3)
                image = simulator.take_screenshot_pil()
                screenshot = simulator.edit_photo(image)
                ocr_res = simulator.ocr.runBytes(screenshot)
                
                if simulator.compare_ocr_text(ocr_res, "旅情事记"):
                    center = simulator.get_box_center_by_text(ocr_res, "旅情事记")
                    if center:
                        simulator.click(center[0], center[1])
                    self._wait(3)
                    image = simulator.take_screenshot_pil()
                    screenshot = simulator.edit_photo(image, "activity")
                    ocr_res = simulator.ocr.runBytes(screenshot)
                    center = simulator.get_box_center_by_text(ocr_res, "巡星之礼", exact=False)
                    
                    if center:
                        simulator.click(center[0], center[1])
                        self._wait(2)
                        while True:
                            if simulator.click_element("./res/images/daily_task/activity_receive_award.png", is_save=True,
                                                      screenshot_module="activity"):
                                self._wait(2)
                                if simulator.click_element("./res/images/daily_task/activity_receive_close.png", is_save=True,
                                                          screenshot_module="activity_close"):
                                    self._wait(2)
                            else:
                                break
            
            self.log.info(f"账号 {self.account} 活动奖励领取完成")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account
            }
            
        except Exception as e:
            self.log.error(f"领取活动奖励时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
    
    def _wait(self, seconds: int) -> None:
        """等待指定秒数"""
        from utils.time_util import TimeUtil
        TimeUtil.sleep(seconds)
```


### 5. 兑换码任务插件

```python
# plugins/daily/redeem_code_plugin.py
from core.plugins.base.plugin_base import PluginBase
import json
import pyperclip
import subprocess

class RedeemCodePlugin(PluginBase):
    """兑换码任务插件"""
    
    @property
    def name(self) -> str:
        return "daily_redeem_code"
    
    @property
    def description(self) -> str:
        return "兑换CDK兑换码"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 50
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行兑换码任务"""
        try:
            self.log.info(f"账号 {self.account} 开始兑换CDK码")
            
            # 获取模拟器实例
            simulator = self.adapter.get_simulator()
            if not simulator:
                raise Exception("无法获取模拟器实例")
            
            # 原有逻辑实现
            orc_path = "./res/account/CDKEY.json"
            # 打开 JSON 文件
            with open(orc_path, 'r') as file:
                # 读取文件内容并解析 JSON 数据
                data = json.load(file)
            # 访问解析后的数据
            keys = data["key"]
            # 兑换码
            success_keys = []
            failed_keys = []
            
            for key in keys:
                self.log.info(f"当前兑换码为：{key}")
                try:
                    if simulator.click_element("./res/images/daily_task/more.png"):
                        self._wait(2)
                        if simulator.click_element("./res/images/daily_task/redeem_code.png"):
                            self._wait(2)
                            if simulator.click_element("./res/images/daily_task/redeem_code_input.png"):
                                self._wait(2)
                                pyperclip.copy(key)
                                self.log.info(f"已复制到剪切板: {key}")
                                text = key.replace(' ', '%s')  # 处理空格
                                subprocess.run(f'adb shell input text "{text}"', shell=True)
                                if simulator.click_element("./res/images/daily_task/input_affirm.png"):
                                    self._wait(2)
                                    if simulator.click_element("./res/images/daily_task/affirm.png", is_save=True,
                                                              screenshot_module=f"CD-KEY-{key}"):
                                        self._wait(2)
                                        if simulator.click_element("./res/images/daily_task/redeem_code_no.png"):
                                            self._wait(2)
                                            if simulator.click_element("./res/images/daily_task/redeem_code_close.png"):
                                                self._wait(2)
                                        if simulator.click_element("./res/images/daily_task/affirm.png", is_save=True,
                                                                  screenshot_module=f"CD-KEY-{key}-SUCCEED"):
                                            self.log.info(f"兑换成功----CD-KEY-{key}")
                                            success_keys.append(key)
                                            self._wait(2)
                        else:
                            failed_keys.append(key)
                except Exception as e:
                    self.log.error(f"兑换码 {key} 处理失败: {str(e)}")
                    failed_keys.append(key)
            
            self.log.info(f"账号 {self.account} CDK码兑换完成，成功: {len(success_keys)}, 失败: {len(failed_keys)}")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account,
                "success_keys": success_keys,
                "failed_keys": failed_keys
            }
            
        except Exception as e:
            self.log.error(f"兑换CDK码时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
    
    def _wait(self, seconds: int) -> None:
        """等待指定秒数"""
        from utils.time_util import TimeUtil
        TimeUtil.sleep(seconds)
```


### 6. 日常任务组合插件

```python
# plugins/daily/daily_all_plugin.py
from core.plugins.base.plugin_base import PluginBase

class DailyAllPlugin(PluginBase):
    """日常任务组合插件"""
    
    @property
    def name(self) -> str:
        return "daily_all"
    
    @property
    def description(self) -> str:
        return "执行所有日常任务"
    
    @property
    def version(self) -> str:
        return "1.0.0"
    
    @property
    def priority(self) -> int:
        return 5
    
    @property
    def category(self) -> str:
        return "daily"
    
    def execute(self, **kwargs) -> dict:
        """执行所有日常任务"""
        try:
            self.log.info(f"账号 {self.account} 开始执行所有日常任务")
            
            # 通过插件管理器执行所有日常任务插件
            results = self.adapter.plugin_manager.execute_plugins_by_category("daily")
            
            self.log.info(f"账号 {self.account} 所有日常任务执行完成")
            return {
                "status": "success",
                "plugin": self.name,
                "account": self.account,
                "results": results
            }
            
        except Exception as e:
            self.log.error(f"执行所有日常任务时发生错误: {str(e)}")
            return {
                "status": "error",
                "plugin": self.name,
                "account": self.account,
                "error": str(e)
            }
```


## 使用方式

改造完成后，你可以通过以下方式使用这些插件：

```python
# 在适配器中使用
from core.adapter.star_rail.star_rail_adapter import StarRailAdapter

# 创建适配器实例
adapter = StarRailAdapter(port=12345, icon="icon_path", account="test_account")

# 执行单个日常任务
result = adapter.plugin_manager.execute_plugin("daily_entrust")

# 执行所有日常任务
result = adapter.plugin_manager.execute_plugins_by_category("daily")

# 通过任务调度器执行（定时任务）
task_id = adapter.task_scheduler.schedule_task("daily_all")
```


## 配置文件示例

```json
{
  "plugin_paths": [
    "plugins",
    "plugins/daily"
  ],
  "enabled_plugins": [
    "daily_entrust",
    "daily_mail",
    "daily_liveness",
    "daily_activity",
    "daily_redeem_code",
    "daily_all"
  ],
  "plugin_settings": {
    "daily_entrust": {
      "priority": 10
    },
    "daily_mail": {
      "priority": 20
    },
    "daily_liveness": {
      "priority": 30
    },
    "daily_activity": {
      "priority": 40
    },
    "daily_redeem_code": {
      "priority": 50
    }
  }
}
```


## 改造优势

1. **模块化**：每个功能都是独立的插件，便于维护和扩展
2. **可配置**：通过配置文件控制插件的启用和执行顺序
3. **可复用**：插件可以在不同账户和场景中复用
4. **易测试**：每个插件可以独立进行单元测试
5. **错误隔离**：单个插件的错误不会影响其他插件
6. **生命周期管理**：插件具备完整的初始化和清理机制
7. **优先级控制**：支持按优先级顺序执行插件
8. **分类管理**：支持按分类执行插件组

这种改造方式将原有的静态方法转换为具有完整生命周期管理的插件，同时保持了原有功能的完整性。